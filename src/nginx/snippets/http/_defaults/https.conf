# Force HTTPS?

# In CF Flexible SSL mode, all connections occur over port 80. CloudFlare proxies them over SSL via DNS.
# So it's important to look at the upstream scheme by inspecting the `CF-Visitor` header when it can be trusted.

set $_http_cf_visitor_scheme_https 0;

if ($http_cf_visitor ~ '\{"scheme"\:"https"\}') {
  set $_http_cf_visitor_scheme_https 1;
}
map $CFG_WEB_SERVER_SSL_ONLY:$server_port:$CFG_FIREWALL_ALLOWS_CF_ONLY_VIA_80_443:$_http_cf_visitor_scheme_https $_https_enforce {
    default 0;
    ~^1\:80\:0 1;
    ~^1\:80\:1\:0 1;
}
