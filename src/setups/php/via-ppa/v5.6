#!/usr/bin/env bash

if [[ ( "${CFG_INSTALL_PHP_CLI}" == 1 || "${CFG_INSTALL_PHP_FPM}" == 1 ) && "${CFG_INSTALL_PHP_VERSION}" == 5.6 ]]; then

  # Install from Ondrej's PPA.
  # See: <https://launchpad.net/~ondrej/+archive/ubuntu/php5-5.6>

  add-apt-repository ppa:ondrej/php5-5.6 --yes;
  apt-get update; # Update after adding PPA.

  if [[ "${CFG_INSTALL_PHP_CLI}" == 1 ]]; then
    apt-get install php5-cli --yes; fi;

  if [[ "${CFG_INSTALL_PHP_FPM}" == 1 ]]; then
    apt-get install php5-fpm --yes; fi;

  apt-get install php5-mysql --yes;
  apt-get install php5-mysqlnd --yes;
  apt-get install php5-curl --yes;
  apt-get install php5-intl --yes;
  apt-get install php5-pspell --yes;
  apt-get install php5-gmp --yes;
  apt-get install php5-gd --yes;
  apt-get install php5-mcrypt --yes;
  apt-get install php5-memcached --yes;

  ## Create PHP config file symlink.

  if [[ "${CFG_INSTALL_PHP_CLI}" == 1 ]]; then
    ln --symbolic /bootstrap/src/php/.ini /etc/php5/cli/conf.d/z90.ini; fi;

  ## Create PHP config file symlinks & restart service.

  if [[ "${CFG_INSTALL_PHP_FPM}" == 1 ]]; then
    ln --symbolic /bootstrap/src/php/.ini /etc/php5/fpm/conf.d/z90.ini;

    mv /etc/php5/fpm/pool.d/www.conf /etc/php5/fpm/pool.d/www.conf~;
    ln --symbolic /bootstrap/src/php/fpm/.conf /etc/php5/fpm/pool.d/z90.conf;

    perl -i -wpe 's/^(\s*stop\s+on\s+.*)$/$1\n\numask 0002/u' /etc/init/php5-fpm.conf;

    if in-docker && can-run sv; then
      mkdir --parents /etc/service/php5-fpm;
      ln --symbolic /bootstrap/src/docker/runit/php5-fpm /etc/service/php5-fpm/run;
    fi;
    service php5-fpm restart; # Restart service; PHP process manager.
  fi;

else echo 'Skipping PHP v5.6 installation.'; fi;
