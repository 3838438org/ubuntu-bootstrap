#!/usr/bin/env bash

if [[ "${CFG_INSTALL_PHP}" == 1 && "${CFG_INSTALL_PHP_VERSION}" == 7.0 ]]; then

  # Install from Ondrej's PPA.
  # See: <https://launchpad.net/~ondrej/+archive/ubuntu/php-7.0>

  add-apt-repository ppa:ondrej/php-7.0 --yes;
  apt-get update; # Update after adding PPA.

  apt-get install php7.0-cli --yes;
  apt-get install php7.0-fpm --yes;

  apt-get install php7.0-mysql --yes;
  apt-get install php7.0-curl --yes;
  apt-get install php7.0-intl --yes;
  apt-get install php7.0-pspell --yes;
  apt-get install php7.0-bz2 --yes;
  apt-get install php7.0-gd --yes;

  ## Create PHP config file symlinks.

  ln --symbolic /bootstrap/assets/php/.ini /etc/php/7.0/cli/conf.d/z90.ini;
  ln --symbolic /bootstrap/assets/php/.ini /etc/php/7.0/fpm/conf.d/z90.ini;

  mv /etc/php/7.0/fpm/pool.d/www.conf /etc/php/7.0/fpm/pool.d/www.conf~;
  ln --symbolic /bootstrap/assets/php/fpm/.conf /etc/php/7.0/fpm/pool.d/z90.conf;

  perl -i -wpe 's/^(\s*)start\-stop\-daemon\s+\-\-start\s+/$1start-stop-daemon --umask 0002 --start /um' /etc/init.d/php7.0-fpm;

  # Restart service.

  service php7.0-fpm restart;

else echo 'Skipping PHP v7.0 installation.'; fi;
